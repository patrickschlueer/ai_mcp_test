<div class="card">
  <div class="card-header">
    <h2>Users ({{ filteredUsers.length }} of {{ totalUsers }})</h2>
    <div class="header-actions">
      <button class="btn btn-toggle-filter" 
              (click)="toggleFilter()" 
              [class.active]="showFilter"
              aria-label="Toggle filter panel">
        🔍 Filter
      </button>
      <button class="btn btn-refresh" (click)="onRefresh()">
        🔄 Refresh
      </button>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" *ngIf="showFilter" [@slideDown]>
    <app-user-filter
      [filterCriteria]="filterCriteria"
      [availableRoles]="availableRoles"
      (filterChange)="onFilterChange($event)"
      (clearFilter)="onClearFilter()">
    </app-user-filter>
  </div>

  <!-- Quick Filters -->
  <div class="quick-filters" *ngIf="!showFilter">
    <button class="btn btn-quick-filter"
            [class.active]="isQuickFilterActive('active')"
            (click)="applyQuickFilter('active')">
      Active Users
    </button>
    <button class="btn btn-quick-filter"
            [class.active]="isQuickFilterActive('admin')"
            (click)="applyQuickFilter('admin')">
      Admins
    </button>
    <button class="btn btn-quick-filter"
            [class.active]="isQuickFilterActive('recent')"
            (click)="applyQuickFilter('recent')">
      Recent
    </button>
    <button class="btn btn-clear-filter"
            *ngIf="hasActiveFilters"
            (click)="onClearFilter()">
      Clear All
    </button>
  </div>

  <!-- Active Filter Summary -->
  <div class="filter-summary" *ngIf="hasActiveFilters && !showFilter">
    <span class="filter-info">Filtered by:</span>
    <span class="filter-tag" *ngFor="let filter of activeFilterTags">
      {{ filter.label }}
      <button class="filter-remove" 
              (click)="removeFilter(filter.key)"
              aria-label="Remove {{ filter.label }} filter">
        ✕
      </button>
    </span>
  </div>

  <div class="loading" *ngIf="loading">Loading users...</div>

  <div class="no-data" *ngIf="!loading && filteredUsers.length === 0 && !hasActiveFilters">
    No users found. Create one above!
  </div>

  <div class="no-results" *ngIf="!loading && filteredUsers.length === 0 && hasActiveFilters">
    <div class="no-results-content">
      <p>No users match your current filters.</p>
      <button class="btn btn-secondary" (click)="onClearFilter()">
        Clear Filters
      </button>
    </div>
  </div>

  <div class="table-container" *ngIf="!loading && filteredUsers.length > 0">
    <table>
      <thead>
        <tr>
          <th class="sortable" 
              (click)="onSort('name')"
              [class.sort-asc]="sortField === 'name' && sortDirection === 'asc'"
              [class.sort-desc]="sortField === 'name' && sortDirection === 'desc'">
            Name
            <span class="sort-indicator" *ngIf="sortField === 'name'">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="sortable"
              (click)="onSort('email')"
              [class.sort-asc]="sortField === 'email' && sortDirection === 'asc'"
              [class.sort-desc]="sortField === 'email' && sortDirection === 'desc'">
            Email
            <span class="sort-indicator" *ngIf="sortField === 'email'">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="sortable"
              (click)="onSort('role')"
              [class.sort-asc]="sortField === 'role' && sortDirection === 'asc'"
              [class.sort-desc]="sortField === 'role' && sortDirection === 'desc'">
            Role
            <span class="sort-indicator" *ngIf="sortField === 'role'">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th class="sortable"
              (click)="onSort('createdAt')"
              [class.sort-asc]="sortField === 'createdAt' && sortDirection === 'asc'"
              [class.sort-desc]="sortField === 'createdAt' && sortDirection === 'desc'">
            Created
            <span class="sort-indicator" *ngIf="sortField === 'createdAt'">{{ sortDirection === 'asc' ? '↑' : '↓' }}</span>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <app-user-table-row 
          *ngFor="let user of filteredUsers; trackBy: trackByUserId"
          [user]="user"
          [highlightFields]="getHighlightFields()"
          (edit)="onEdit($event)"
          (delete)="onDelete($event)">
        </app-user-table-row>
      </tbody>
    </table>
  </div>

  <!-- Bulk Actions for filtered results -->
  <div class="bulk-actions" *ngIf="filteredUsers.length > 0 && hasActiveFilters">
    <span class="bulk-info">{{ filteredUsers.length }} users selected by filters</span>
    <button class="btn btn-bulk" (click)="onBulkExport()">
      📊 Export Filtered
    </button>
  </div>
</div>